graph LR
    %% å®šä¹‰æ ·å¼
    classDef tensor fill:#e3f2fd,stroke:#1565c0,stroke-width:2px,color:#0d47a1,rx:5,ry:5;
    classDef module fill:#fff3e0,stroke:#e65100,stroke-width:2px,color:#bf360c,rx:5,ry:5;
    classDef buffer fill:#e8f5e9,stroke:#2e7d32,stroke-width:3px,stroke-dasharray: 5 5,color:#1b5e20,rx:5,ry:5;
    classDef operation fill:#f5f5f5,stroke:#616161,stroke-width:1px,color:#424242,rx:10,ry:10;
    classDef container fill:#ffffff,stroke:#cfd8dc,stroke-width:2px,stroke-dasharray: 2 2;

    %% ================= è¾“å…¥å±‚ =================
    subgraph Input_Stage ["Start: ç¥ç»æ„ŸçŸ¥ (Input)"]
        EEG_IN("ğŸ“„ EEG Window Input<br/>Shape: [B, T, C]<br/>e.g., [4, 300, 64]"):::tensor
    end

    %% ================= æ¨¡å—ä¸€ï¼šæ—¶åºç¼–ç å™¨ =================
    subgraph Mod1 ["Mod 1: Neural Driver (EEG 'Conductor' Encoder)"]
        style Mod1 fill:#fff8e1,stroke:#ff6f00
        direction TB
        CNN("ğŸŸ§ 1D CNN<br/>(Temporal Features)"):::module
        LSTM("ğŸŸ§ LSTM<br/>(Temporal Dynamics)"):::module
        Linear("ğŸŸ§ Linear Projection<br/>(To K Components)"):::module
        EEG_IN --> CNN --> LSTM --> Linear
    end

    %% ä¸­é—´å˜é‡ï¼šæƒé‡æŒ‡ä»¤
    WEIGHTS("ğŸ« Component Weights (w)<br/>Shape: [B, K]<br/>e.g., [4, 64]<br/>'æŒ‡æŒ¥å®¶æŒ‡ä»¤'"):::tensor
    Linear --> WEIGHTS

    %% ================= æ¨¡å—äºŒï¼šç‰©ç†æŠ•å½± =================
    subgraph Mod2 ["Mod 2: Basis Projector (ICA 'Instrument' Performance)"]
        style Mod2 fill:#e8f5e9,stroke:#1b5e20
        
        %% æ ¸å¿ƒæœºåˆ¶ï¼šå†»ç»“åŸºåº•ä¸è¿ç®—
        subgraph Projection_Mechanism ["Physics-based Reconstruction"]
            style Projection_Mechanism fill:#ffffff,stroke:none
            BASIS[/"ğŸ’¾ Frozen ICA Basis Buffer (S)<br/>Shape: [K, D, H, W]<br/>e.g., [64, 53, 63, 52]<br/>(FIXED PARAMETERS)"/]::rada:::buffer
            EINSUM(("âš™ï¸ Einsum Op<br/>Sum(w * S)")):::operation
            
            WEIGHTS -- "åŠ¨æ€æƒé‡ (b, k)" --> EINSUM
            BASIS -- "é™æ€åŸºåº• (k, d,h,w)" --> EINSUM
        end
        
        VOL_ROUGH("ğŸ“¦ Rough Activation Vol<br/>Shape: [B, 1, D, H, W]<br/>(Adding Channel Dim)"):::tensor
        EINSUM --> VOL_ROUGH
    end

    %% ================= æ¨¡å—ä¸‰ï¼šè¯­ä¹‰åˆ†å‰²å¤´ =================
    subgraph Mod3 ["Mod 3: Segmentation Head (State Classification)"]
        style Mod3 fill:#ede7f6,stroke:#4527a0
        CONV3D("ğŸŸ§ 3D Conv 1x1<br/>(Map 1-Ch to 3-Ch Classes)"):::module
        VOL_ROUGH --> CONV3D
    end

    %% ================= è¾“å‡ºå±‚ =================
    subgraph Output_Stage ["End: å…¨è„‘çŠ¶æ€ (Output)"]
        OUTPUT("ğŸ² Output Probability Map<br/>Shape: [B, 3, D, H, W]<br/>(Ch0:Bg, Ch1:Act, Ch2:Inhib)"):::tensor
        CONV3D --> OUTPUT
    end

    %% æ•´ä½“è¿æ¥è°ƒæ•´
    LinkStyle 4 stroke-width:3px,fill:none,stroke:#ff6f00,color:red; %% å¼ºè°ƒæƒé‡è¿æ¥
    LinkStyle 5 stroke-width:3px,fill:none,stroke:#2e7d32; %% å¼ºè°ƒåŸºåº•è¿æ¥